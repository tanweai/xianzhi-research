# 提权/绕过安全研究方法论

## 元思考框架

### 提权的本质

提权 = 突破当前权限边界，获取更高权限的访问能力

| 维度 | 核心思路 |
|------|----------|
| **内核层** | 利用内核漏洞直接获取SYSTEM/root |
| **服务层** | 利用高权限服务的配置错误 |
| **应用层** | 利用SUID/sudo/服务账户 |
| **配置层** | 利用错误的权限配置 |

---

## 提权向量识别

### Windows提权向量

| 向量类型 | 检查方法 | 利用方式 |
|----------|----------|----------|
| **服务配置错误** | accesschk | 修改服务二进制路径 |
| **弱权限目录** | icacls | DLL劫持 |
| **计划任务** | schtasks /query | 替换任务执行文件 |
| **AlwaysInstallElevated** | 注册表检查 | 恶意MSI安装 |
| **Potato系列** | SeImpersonate权限 | 模拟高权限Token |
| **Unquoted Service Path** | wmic | 路径劫持 |

### Linux提权向量

| 向量类型 | 检查命令 | 利用方式 |
|----------|----------|----------|
| **SUID二进制** | find / -perm -4000 | GTFOBins查询 |
| **sudo配置** | sudo -l | 命令滥用 |
| **Capabilities** | getcap -r / | 特权能力滥用 |
| **Cron任务** | cat /etc/crontab | 任务劫持 |
| **内核漏洞** | uname -a | 公开exploit |
| **Docker逃逸** | docker组成员 | 挂载宿主机 |

### 内核漏洞提权

| CVE | 影响版本 | 利用效果 |
|-----|----------|----------|
| CVE-2021-3156 (Baron Samedit) | sudo < 1.9.5p2 | root权限 |
| CVE-2021-4034 (PwnKit) | polkit < 0.120 | root权限 |
| CVE-2022-0847 (Dirty Pipe) | Linux 5.8+ | 任意文件写入 |

---

## WAF绕过策略

### 绕过思维模型

```
WAF检测逻辑 → 找到检测盲区 → 构造绕过payload
     ↓              ↓              ↓
  规则分析      语义差异利用     验证绕过
```

### 通用绕过技术

| 绕过类型 | 技术手段 |
|----------|----------|
| **编码绕过** | URL编码、Unicode、HTML实体 |
| **大小写混淆** | UnIoN SeLeCt |
| **注释插入** | sel/**/ect、se%00lect |
| **空白符替换** | %09、%0a、%0d、/**/ |
| **分块传输** | Transfer-Encoding: chunked |
| **参数污染** | ?id=1&id=2 (HPP) |
| **协议层面** | HTTP/2、WebSocket |

### 特定WAF绕过

| WAF | 已知绕过 |
|-----|----------|
| **Cloudflare** | Unicode标准化差异 |
| **ModSecurity** | 规则配置缺陷 |
| **国产WAF** | 编码处理差异 |

---

## EDR/AV绕过

### 免杀技术层次

```
指令级(等价替换) → 结构级(控制流平坦化) → 数据级(多算法加密) → 噪音注入
```

### 绕过技术矩阵

| 技术类型 | 实现方式 | 效果 |
|----------|----------|------|
| **特征码修改** | 等价指令替换、资源修改 | 绕过静态检测 |
| **内存加载** | 无文件落地、反射DLL | 绕过磁盘扫描 |
| **进程注入** | 远程线程、APC注入 | 隐藏恶意代码 |
| **直接系统调用** | syscall直接调用 | 绕过API hook |
| **AMSI绕过** | Patch amsi.dll | 绕过脚本检测 |
| **ETW绕过** | 禁用ETW日志 | 绕过行为监控 |

### 进程注入技术

| 技术 | API调用 | 特点 |
|------|---------|------|
| **远程线程** | CreateRemoteThread | 经典方法，易被检测 |
| **APC注入** | QueueUserAPC | 需要可告警线程 |
| **线程劫持** | SetThreadContext | 不创建新线程 |
| **进程镂空** | NtUnmapViewOfSection | 替换进程映像 |

---

## 沙箱绕过

### 沙箱检测六维度

| 检测维度 | 检测方法 | 绕过思路 |
|----------|----------|----------|
| **用户名** | 检测沙箱用户名 | 延迟执行 |
| **调试器** | IsDebuggerPresent | 反反调试 |
| **VM痕迹** | 注册表、进程、设备 | 特征清除 |
| **系统资源** | CPU核心、内存、磁盘 | 资源检查 |
| **运行时间** | 系统启动时间 | 时间检查 |
| **父进程** | 进程链检查 | 父进程伪造 |

### 父进程伪造

```cpp
// 使用STARTUPINFOEX指定父进程
STARTUPINFOEXW si = { sizeof(si) };
UpdateProcThreadAttribute(si.lpAttributeList,
    PROC_THREAD_ATTRIBUTE_PARENT_PROCESS,
    &hParentProcess, sizeof(HANDLE), NULL, NULL);
```

---

## 核心洞察

1. **提权是权限边界的突破**：从配置错误到内核漏洞，层层递进
2. **WAF绕过靠语义差异**：不同组件对同一输入的解析差异
3. **免杀是持续对抗**：静态→动态→行为，检测和绕过不断演进
4. **沙箱检测六维度**：用户名、调试器、VM、资源、时间、父进程
5. **直接系统调用**：绕过用户态hook的终极手段
