# 域渗透/内网安全研究方法论

## 元思考框架

### 域渗透的本质认知

域渗透的核心是**信任关系的滥用**：

| 维度 | 核心洞察 |
|------|----------|
| **认证机制** | Kerberos/NTLM协议的设计缺陷是攻击的基础土壤 |
| **委派机制** | 权限传递链条的设计为横向移动提供了合法通道 |
| **信任传递** | 域信任关系可被滥用实现跨域攻击 |
| **集中管理** | 域控制器作为单点成为高价值目标 |

### 攻击者思维模型

```
边界突破 → 立足点建立 → 信息收集 → 权限提升 → 横向移动 → 域控攻击 → 权限维持
    ↑                                                                    ↓
    └────────────────── 持久化后门确保重入 ─────────────────────────────────┘
```

---

## 信息收集矩阵

### 域环境基础信息

| 收集目标 | 工具/命令 | 输出价值 |
|----------|-----------|----------|
| 域名/域控 | `nltest /dclist:domain` | 确定攻击目标 |
| 域SID | `whoami /user` | 票据伪造必需 |
| 域管理员 | `net group "Domain Admins" /domain` | 高价值目标 |
| 域信任关系 | `nltest /domain_trusts` | 跨域攻击判断 |
| KRBTGT Hash | `lsadump::dcsync /user:krbtgt` | 黄金票据制作 |

### SPN服务探测

**核心洞察**：SPN是Kerberos客户端标识服务的唯一方式，基于SPN的服务探测比端口扫描更精准且隐蔽。

```powershell
setspn -T domain -Q */*                    # 查询域内所有SPN
setspn -T domain -Q */* | findstr "MSSQLSvc"  # 查询MSSQL
Get-NetUser -SPN | Select serviceprincipalname  # PowerView
```

### BloodHound关键边缘

| 边缘类型 | 攻击价值 |
|----------|----------|
| `HasSession` | 用户凭证可能驻留内存 |
| `AdminTo` | 直接本地管理员权限 |
| `GenericAll` | 完全控制对象 |
| `WriteDacl` | 可修改ACL实现提权 |
| `DCSync` | GetChanges+GetChangesAll可导出hash |

---

## 攻击路径决策树

```
普通域用户
    │
    ├─── [有SPN注册] ──→ Kerberoasting离线爆破
    │
    ├─── [AS-REP Roastable] ──→ 无预认证攻击
    │
    ├─── [可创建机器账户] ──→ RBCD攻击
    │
    ├─── [存在委派配置] ──→ 委派攻击
    │         ├─── 非约束委派: 捕获TGT
    │         └─── 约束委派: S4U2Self + S4U2Proxy
    │
    ├─── [ADCS配置不当] ──→ ESC1-ESC15证书攻击
    │
    └─── [存在漏洞] ──→ CVE利用
              ├─── MS14-068 (PAC伪造)
              ├─── CVE-2021-42287/42278 (sAMAccountName欺骗)
              └─── CVE-2020-1472 (ZeroLogon)
```

---

## 横向移动决策

| 场景条件 | 推荐方法 | 端口依赖 |
|----------|----------|----------|
| 拥有明文密码 | PSExec/WMI | 445/135 |
| 仅有NTLM Hash | PTH (Pass-The-Hash) | 445 |
| 拥有Kerberos票据 | PTT (Pass-The-Ticket) | 88 |
| 目标无SMB签名 | NTLM Relay | 445 |
| 目标有WinRM | Evil-WinRM | 5985/5986 |

---

## Kerberos攻击矩阵

| 攻击类型 | 前提条件 | 产出 |
|----------|----------|------|
| **AS-REP Roasting** | 用户开启"不要求预认证" | 用户明文密码 |
| **Kerberoasting** | 用户注册有SPN | 服务账户密码 |
| **黄金票据** | 获取KRBTGT Hash | 域管权限 |
| **白银票据** | 获取服务账户Hash | 服务访问权限 |
| **MS14-068** | 域控未打KB3011780 | 域管权限 |

---

## 委派攻击

### 非约束委派
```
触发条件: 域管访问配置了非约束委派的机器
利用链: 控制机器 → 触发域控访问(打印机漏洞) → 捕获域控TGT → DCSync
```

### 约束委派
```
触发条件: 获取配置了约束委派的账户凭据
利用链: S4U2Self获取票据 → S4U2Proxy转发 → 访问目标服务
```

### RBCD (基于资源的约束委派)
```
触发条件: 可创建机器账户 + 对目标有msDS-AllowedToActOnBehalfOfOtherIdentity写权限
利用链: 创建恶意机器账户 → 修改RBCD属性 → S4U2Self+S4U2Proxy → SYSTEM权限
```

---

## 持久化技术栈

| 技术 | 隐蔽性 | 持久性 | 前提条件 |
|------|--------|--------|----------|
| **黄金票据** | 高 | 直到KRBTGT改密2次 | KRBTGT Hash |
| **白银票据** | 高 | 直到服务账户改密 | 服务账户Hash |
| **AdminSDHolder** | 高 | 永久 | 域控权限 |
| **SID History** | 高 | 永久 | 域控权限 |
| **DSRM后门** | 高 | 永久 | 域控权限 |

### 推荐持久化组合

```
第一层: 黄金票据（快速恢复域管权限）
第二层: AdminSDHolder（普通用户即可恢复高权限）
第三层: SSP/DSRM（即使票据失效也可捕获新凭证）
第四层: RBCD变种黄金票据（KRBTGT改密也不影响）
```

---

## ADCS证书攻击速查

| ESC编号 | 核心配置错误 | 利用效果 |
|---------|--------------|----------|
| ESC1 | 模板允许指定SAN + 普通用户可注册 | 申请任意用户证书 |
| ESC4 | 普通用户对模板有写权限 | 修改模板为ESC1 |
| ESC8 | Web Enrollment启用HTTP | NTLM Relay获取证书 |

---

## 核心洞察

1. **系统性思维**：域渗透不是单点突破，而是信任链条的逐级瓦解
2. **杠杆效应**：一个委派配置错误可能导致整个域的沦陷
3. **逆向思考**：防守方关注的补丁和加固措施，恰恰指明了攻击方向
4. **隐蔽性悖论**：最隐蔽的攻击往往利用的是合法的域功能而非漏洞
